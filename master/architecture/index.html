<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Red Hat Quay architecture</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.4"/><meta name="description" content="Red Hat Quay Architecture"/><link rel="next" href="#arch-intro" title="Chapter 1. Red Hat Quay overview"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm46054487102752"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.9</span></div><div><h1 class="title">Red Hat Quay architecture</h1></div><div><h2 class="subtitle">Red Hat Quay Architecture</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm46054463269952">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Red Hat Quay Architecture
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="chapter"><a href="#arch-intro">1. Red Hat Quay overview</a></span><ul><li><span class="section"><a href="#arch-intro-scalability">1.1. Scalability and high availability (HA)</a></span></li><li><span class="section"><a href="#arch-intro-content-distribution">1.2. Content distribution</a></span></li><li><span class="section"><a href="#arch-intro-build-automation">1.3. Build automation</a></span></li><li><span class="section"><a href="#red-hat-quay-builds-architecture">1.4. Red Hat Quay enhanced build architecture</a></span></li><li><span class="section"><a href="#arch-intro-integration">1.5. Integration</a></span><ul><li><span class="section"><a href="#arch-rest-api">1.5.1. REST API</a></span></li></ul></li><li><span class="section"><a href="#arch-intro-security">1.6. Security</a></span><ul><li><span class="section"><a href="#arch-tls-ssl-config">1.6.1. TLS/SSL configuration</a></span></li><li><span class="section"><a href="#arch-intro-clair">1.6.2. Clair</a></span></li><li><span class="section"><a href="#arch-operator-security">1.6.3. Red Hat Quay Operator security</a></span></li><li><span class="section"><a href="#arch-builders">1.6.4. Fully isolated builds</a></span></li><li><span class="section"><a href="#arch-rbac">1.6.5. Role-based access controls</a></span></li></ul></li><li><span class="section"><a href="#arch-intro-recent-features">1.7. Recently added features</a></span></li></ul></li><li><span class="chapter"><a href="#arch-prereqs">2. Red Hat Quay prerequisites</a></span><ul><li><span class="section"><a href="#core-prereqs-storage">2.1. Image storage backend</a></span><ul><li><span class="section"><a href="#arch-supported-image-storage-types">2.1.1. Supported image storage engines</a></span></li></ul></li><li><span class="section"><a href="#arch-core-prereqs-db">2.2. Database backend</a></span></li><li><span class="section"><a href="#core-prereqs-redis">2.3. Redis</a></span></li></ul></li><li><span class="chapter"><a href="#arch-quay-infrastructure">3. Red Hat Quay infrastructure</a></span><ul><li><span class="section"><a href="#arch-quay-standalone-hosts">3.1. Running Red Hat Quay on standalone hosts</a></span></li><li><span class="section"><a href="#arch-quay-openshift">3.2. Running Red Hat Quay on OpenShift</a></span></li><li><span class="section"><a href="#arch-integrating-standalone-ocp">3.3. Integrating standalone Red Hat Quay with OpenShift Container Platform</a></span></li><li><span class="section"><a href="#arch-mirror-registry">3.4. Mirror registry for Red Hat OpenShift</a></span></li><li><span class="section"><a href="#core-distinct-registries">3.5. Single compared to multiple registries</a></span></li></ul></li><li><span class="chapter"><a href="#sample-quay-on-prem-intro">4. Deploying Red Hat Quay on premise</a></span><ul><li><span class="section"><a href="#core-example-deployment">4.1. Red Hat Quay example deployments</a></span></li><li><span class="section"><a href="#deployment-topology">4.2. Red Hat Quay deployment topology</a></span></li><li><span class="section"><a href="#deployment-topology-with-storage-proxy">4.3. Red Hat Quay deployment topology with storage proxy</a></span></li></ul></li><li><span class="chapter"><a href="#arch-deploy-quay-public-cloud">5. Deploying Red Hat Quay on public cloud</a></span><ul><li><span class="section"><a href="#arch-quay-on-aws">5.1. Running Red Hat Quay on Amazon Web Services</a></span></li><li><span class="section"><a href="#arch-quay-on-azure">5.2. Running Red Hat Quay on Microsoft Azure</a></span></li></ul></li><li><span class="chapter"><a href="#content-distrib-intro">6. Content distribution with Red Hat Quay</a></span><ul><li><span class="section"><a href="#arch-mirroring-intro">6.1. Repository mirroring</a></span><ul><li><span class="section"><a href="#arch-mirroring-using">6.1.1. Using repository mirroring</a></span></li><li><span class="section"><a href="#arch-mirroring-recommend">6.1.2. Repository mirroring recommendations</a></span></li><li><span class="section"><a href="#arch-mirroring-events">6.1.3. Event notifications for mirroring</a></span></li><li><span class="section"><a href="#arch-mirroring-api-intro">6.1.4. Mirroring API</a></span></li></ul></li><li><span class="section"><a href="#georepl-intro">6.2. Geo-replication</a></span><ul><li><span class="section"><a href="#arch-georpl-features">6.2.1. Geo-replication features</a></span></li><li><span class="section"><a href="#arch-georepl-prereqs">6.2.2. Geo-replication requirements and constraints</a></span></li><li><span class="section"><a href="#georepl-arch-standalone">6.2.3. Geo-replication using standalone Red Hat Quay</a></span></li><li><span class="section"><a href="#georepl-arch-operator">6.2.4. Geo-replication using the Red Hat Quay Operator</a></span></li><li><span class="section"><a href="#georepl-mixed-storage">6.2.5. Mixed storage for geo-replication</a></span></li></ul></li><li><span class="section"><a href="#mirroring-versus-georepl">6.3. Repository mirroring compared to geo-replication</a></span></li><li><span class="section"><a href="#arch-airgap-intro">6.4. Air-gapped or disconnected deployments</a></span></li></ul></li><li><span class="chapter"><a href="#sizing-intro">7. Red Hat Quay sizing and subscriptions</a></span><ul><li><span class="section"><a href="#sizing-sample">7.1. Red Hat Quay sample sizings</a></span></li><li><span class="section"><a href="#subscription-intro">7.2. Red Hat Quay subscription information</a></span></li><li><span class="section"><a href="#quay-internal-registry-intro">7.3. Using Red Hat Quay with or without internal registry</a></span></li></ul></li></ul></div><section class="chapter" id="arch-intro"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Red Hat Quay overview</h1></div></div></div><p>
			Red Hat Quay is a distributed and highly available container image registry for your enterprise.
		</p><p>
			Red Hat Quay container registry platform provides secure storage, distribution, access controls, geo-replications, repository mirroring, and governance of containers and cloud-native artifacts on any infrastructure. It is available as a standalone component or as an Operator for OpenShift Container Platform, and is deployable on-prem or on a public cloud.
		</p><p>
			<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_features.png" alt="Quay features"/></span>
		</p><p>
			This guide provides an insight into architectural patterns to use when deploying Red Hat Quay. This guide also offers sizing guidance and deployment prerequisites, along with best practices for ensuring high availability for your Red Hat Quay registry.
		</p><section class="section" id="arch-intro-scalability"><div class="titlepage"><div><div><h2 class="title">1.1. Scalability and high availability (HA)</h2></div></div></div><p>
				The code base used for Red Hat Quay is the same as the code base used for <a class="link" href="https::/quay.io">Quay.io</a>, which is the highly available container image registry hosted by Red Hat. Quay.io and Red Hat Quay offer a multitenant SaaS solution. As a result, users can be confident that their deployment can deliver at scale with high availability, whether their deployment is on-prem or on a public cloud.
			</p></section><section class="section" id="arch-intro-content-distribution"><div class="titlepage"><div><div><h2 class="title">1.2. Content distribution</h2></div></div></div><p>
				Content distribution features in Red Hat Quay include the following:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Repository mirroring</span></dt><dd>
							Red Hat Quay repository mirroring lets you mirror images from Red Hat Quay and other container registries, like JFrog Artifactory, Harbor, or Sonatype Nexus Repository, into your Red Hat Quay cluster. Using repository mirroring, you can synchronize images to Red Hat Quay based on repository names and tags.
						</dd><dt><span class="term">Geo-replication</span></dt><dd>
							Red Hat Quay geo-replication allows multiple, geographically distributed Red Hat Quay deployments to work as a single registry from the perspective of a client or user. It significantly improves push and pull performance in a globally-distributed Red Hat Quay setup. Image data is asynchronously replicated in the background with transparent failover and redirection for clients.
						</dd><dt><span class="term">Deployment in disconnected or air-gapped environments</span></dt><dd><p class="simpara">
							Red Hat Quay is deployable in a disconnected environment in one of two ways:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
									Red Hat Quay and Clair connected to the internet, with an air-gapped OpenShift Container Platform cluster accessing the Red Hat Quay registry through an explicit, allowlisted hole in the firewall.
								</li><li class="listitem">
									Using two independent Red Hat Quay and Clair installations. One installation is connected to the internet and another within a disconnected, or firewalled, environment. Image and vulnerability data is manually transferred from the connected environment to the disconnected environment using offline media.
								</li></ul></div></dd></dl></div></section><section class="section" id="arch-intro-build-automation"><div class="titlepage"><div><div><h2 class="title">1.3. Build automation</h2></div></div></div><p>
				Red Hat Quay supports building Dockerfiles using a set of worker nodes on OpenShift Container Platform or Kubernetes platforms. Build triggers, such as GitHub webhooks, can be configured to automatically build new versions of your repositories when new code is committed.
			</p><p>
				Prior to Red Hat Quay 3.7, Red Hat Quay ran Podman commands in virtual machines launched by pods. Running builds on virtual platforms requires enabling nested virtualization, which is not featured in Red Hat Enterprise Linux (RHEL) or OpenShift Container Platform. As a result, builds had to run on bare metal clusters, which is an inefficient use of resources. With Red Hat Quay 3.7, this requirement was removed and builds could be run on OpenShift Container Platform clusters running on virtualized or bare metal platforms.
			</p></section><section class="section" id="red-hat-quay-builds-architecture"><div class="titlepage"><div><div><h2 class="title">1.4. Red Hat Quay enhanced build architecture</h2></div></div></div><p>
				The following image shows the expected design flow and architecture of the enhanced build features:
			</p><p>
				<span class="inlinemediaobject"><img src="images/quay-builds-architecture.png" alt="Enhanced Quay builds architecture"/></span>
			</p><p>
				With this enhancement, the build manager first creates the <code class="literal">Job Object</code>. Then, the <code class="literal">Job Object</code> then creates a pod using the <code class="literal">quay-builder-image</code>. The <code class="literal">quay-builder-image</code> will contain the <code class="literal">quay-builder binary</code> and the <code class="literal">Podman</code> service. The created pod runs as <code class="literal">unprivileged</code>. The <code class="literal">quay-builder binary</code> then builds the image while communicating status and retrieving build information from the Build Manager.
			</p></section><section class="section" id="arch-intro-integration"><div class="titlepage"><div><div><h2 class="title">1.5. Integration</h2></div></div></div><p>
				Red Hat Quay can integrate with almost all Git-compatible systems. Red Hat Quay offers automative configuration for GitHub, GitLab, or BitBucket, which allows users to continuously build and serve their containerized software.
			</p><section class="section" id="arch-rest-api"><div class="titlepage"><div><div><h3 class="title">1.5.1. REST API</h3></div></div></div><p>
					Red Hat Quay provides a full OAuth 2, RESTful API. RESTful API offers the following benefits:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Availability from endpoints of each Red Hat Quay instance from the URL, for example, <code class="literal">https://quay-server.example.com/api/v1</code>
						</li><li class="listitem">
							Allow users to connect to endpoints through a browser, to <code class="literal">GET</code>, <code class="literal">DELETE</code>, <code class="literal">POST</code>, and <code class="literal">PUT</code> Red Hat Quay settings provided by a discovery endpoint that is usable by Swagger.
						</li><li class="listitem">
							The API can be invoked by the URL, for example, <code class="literal">https://quay-server.example.com/api/v1</code>, and uses JSON objects as payload.
						</li></ul></div></section></section><section class="section" id="arch-intro-security"><div class="titlepage"><div><div><h2 class="title">1.6. Security</h2></div></div></div><p>
				Red Hat Quay is built for real enterprise use cases where content governance and security are two major focus areas.
			</p><p>
				Red Hat Quay content governance and security includes built-in vulnerability scanning through Clair.
			</p><section class="section" id="arch-tls-ssl-config"><div class="titlepage"><div><div><h3 class="title">1.6.1. TLS/SSL configuration</h3></div></div></div><p>
					You can configure SSL/TLS for the Red Hat Quay registry in the configuration tool UI or in the configuration bundle. SSL/TSL connections to the database, to image storage, and to Redis can also be specified through the configuration tool.
				</p><p>
					Sensitive fields in the database and at run time are automatically encrypted. You can also require HTTPS and verify certificates for the Red Hat Quay registry during mirror operations.
				</p></section><section class="section" id="arch-intro-clair"><div class="titlepage"><div><div><h3 class="title">1.6.2. Clair</h3></div></div></div><p>
					Clair is an open source application that leverages static code analyses for parsing image content and reporting vulnerabilities affecting the content. Clair is packaged with Red Hat Quay and can be used in both standalone and Operator deployments. It can be run in highly scalable configurations, where components can be scaled separately as appropriate for enterprise environments.
				</p></section><section class="section" id="arch-operator-security"><div class="titlepage"><div><div><h3 class="title">1.6.3. Red Hat Quay Operator security</h3></div></div></div><p>
					When Red Hat Quay is deployed using the Red Hat Quay Operator, the <code class="literal">tls</code> component is set to <code class="literal">managed</code> by default and the OpenShift Container Platform’s Certificate Authority is used to create HTTPS endpoints and to rotate TLS certificates.
				</p><p>
					If you set the <code class="literal">tls</code> component to <code class="literal">unmanaged</code>, you can provide custom certificates to the pass-through Routes, however you are responsible for certificate rotation.
				</p></section><section class="section" id="arch-builders"><div class="titlepage"><div><div><h3 class="title">1.6.4. Fully isolated builds</h3></div></div></div><p>
					Red Hat Quay now supports building Dockerfiles that uses both bare metal and virtual builders.
				</p><p>
					By using bare-metal worker nodes, each build is done in an ephemeral virtual machine to ensure isolation and security while the build is running. This provides the best protection against rogue payloads.
				</p><p>
					Running builds directly in a container does not have the same isolation as when using virtual machines, but it still provides good protection.
				</p></section><section class="section" id="arch-rbac"><div class="titlepage"><div><div><h3 class="title">1.6.5. Role-based access controls</h3></div></div></div><p>
					Red Hat Quay provides full isolation of registry content by organization and team with fine-grained entitlements for read, write, and administrative access by users and automated tools.
				</p></section></section><section class="section" id="arch-intro-recent-features"><div class="titlepage"><div><div><h2 class="title">1.7. Recently added features</h2></div></div></div><p>
				See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.9/html/red_hat_quay_release_notes/index">Red Hat Quay Release Notes</a> for information about the latest features, enhancements, deprecations, and known issues.
			</p></section></section><section class="chapter" id="arch-prereqs"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Red Hat Quay prerequisites</h1></div></div></div><p>
			Before deploying Red Hat Quay, you must provision image storage, a database, and Redis.
		</p><section class="section" id="core-prereqs-storage"><div class="titlepage"><div><div><h2 class="title">2.1. Image storage backend</h2></div></div></div><p>
				Red Hat Quay stores all binary blobs in its storage backend.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Local storage</span></dt><dd>
							Red Hat Quay can work with local storage, however this should only be used for proof of concept or test setups, as the durability of the binary blobs cannot be guaranteed.
						</dd><dt><span class="term">HA storage setup</span></dt><dd><p class="simpara">
							For a Red Hat Quay HA deployment, you must provide HA image storage, for example:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
									<span class="strong strong"><strong>Red Hat OpenShift Data Foundation</strong></span>, previously known as Red Hat OpenShift Container Storage, is software-defined storage for containers. Engineered as the data and storage services platform for OpenShift Container Platform, Red Hat OpenShift Data Foundation helps teams develop and deploy applications quickly and efficiently across clouds. More information can be found at <a class="link" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-data-foundation">https://www.redhat.com/en/technologies/cloud-computing/openshift-data-foundation</a>.
								</li><li class="listitem">
									<span class="strong strong"><strong>Ceph Object Gateway</strong></span> (also called RADOS Gateway) is an example of a storage solution that can provide the the object storage needed by Red Hat Quay. Detailed instructions on how to use Ceph storage as a highly available storage backend can be found in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploy_red_hat_quay_-_high_availability/preparing_for_red_hat_quay_high_availability#set_up_ceph">Quay High Availability Guide</a>. Further information about Red Hat Ceph Storage and HA setups can be found in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/3/pdf/architecture_guide/Red_Hat_Ceph_Storage-3-Architecture_Guide-en-US.pdf">Red Hat Ceph Storage Architecture Guide</a>
								</li></ul></div></dd><dt><span class="term">Geo-replication</span></dt><dd>
							Local storage cannot be used for geo-replication, so a supported on premise or cloud based object storage solution must be deployed. Localized image storage is provided in each region and image pulls are served from the closest available storage engine. Container image pushes are written to the preferred storage engine for the Red Hat Quay instance, and will then be replicated, in the background, to the other storage engines. This requires the image storage to be accessible from all regions.
						</dd></dl></div><section class="section" id="arch-supported-image-storage-types"><div class="titlepage"><div><div><h3 class="title">2.1.1. Supported image storage engines</h3></div></div></div><p>
					Red Hat Quay supports the following on premise storage types:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Ceph/Rados RGW
						</li><li class="listitem">
							OpenStack Swift
						</li><li class="listitem">
							Red Hat OpenShift Data Foundation 4 (through NooBaa)
						</li></ul></div><p>
					Red Hat Quay supports the following public cloud storage engines:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Amazon Web Services (AWS) S3
						</li><li class="listitem">
							Google Cloud Storage
						</li><li class="listitem">
							Azure Blob Storage
						</li></ul></div></section></section><section class="section" id="arch-core-prereqs-db"><div class="titlepage"><div><div><h2 class="title">2.2. Database backend</h2></div></div></div><p>
				Red Hat Quay stores all of its configuration information in the <code class="literal">config.yaml</code> file. Registry metadata, for example, user information, robot accounts, team, permissions, organizations, images, tags, manifests, etc. are stored inside of the database backend. Logs can be pushed to ElasticSearch if required. PostgreSQL is the preferred database backend because it can be used for both Red Hat Quay and Clair.
			</p><p>
				A future version of Red Hat Quay will remove support for using MySQL and MariaDB as the database backend, which has been deprecated since the Red Hat Quay 3.6 release. Until then, MySQL is still supported according to the <a class="link" href="https://access.redhat.com/articles/4067991">support matrix</a>, but will not receive additional features or explicit testing coverage. The Red Hat Quay Operator supports only PostgreSQL deployments when the database is managed. If you want to use MySQL, you must deploy it manually and set the database component to <code class="literal">managed: false</code>.
			</p><p>
				Deploying Red Hat Quay in a highly available (HA) configuration requires that your database services are provisioned for high availability. If Red Hat Quay is running on public cloud infrastructure, it is recommended that you use the PostgreSQL services provided by your cloud provider, however MySQL is also supported.
			</p><p>
				Geo-replication requires a single, shared database that is accessible from all regions.
			</p></section><section class="section" id="core-prereqs-redis"><div class="titlepage"><div><div><h2 class="title">2.3. Redis</h2></div></div></div><p>
				Red Hat Quay stores builder logs inside a Redis cache. Because the data stored is ephemeral, Redis does not need to be highly available even though it is stateful.
			</p><p>
				If Redis fails, you will lose access to build logs, builders, and the garbage collector service. Additionally, user events will be unavailable.
			</p><p>
				You can use a Redis image from the Red Hat Software Collections or from any other source you prefer.
			</p></section></section><section class="chapter" id="arch-quay-infrastructure"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Red Hat Quay infrastructure</h1></div></div></div><p>
			Red Hat Quay runs on any physical or virtual infrastructure, both on premise or public cloud. Deployments range from simple to massively scaled, like the following:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					All-in-one setup on a developer notebook
				</li><li class="listitem">
					Highly available on virtual machines or on OpenShift Container Platform
				</li><li class="listitem">
					Geographically dispersed across multiple availability zones and regions
				</li></ul></div><section class="section" id="arch-quay-standalone-hosts"><div class="titlepage"><div><div><h2 class="title">3.1. Running Red Hat Quay on standalone hosts</h2></div></div></div><p>
				You can automate the standalone deployment process by using Ansible or another automation suite. All standalone hosts require valid a Red Hat Enterprise Linux (RHEL) subscription.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Proof of Concept deployment</span></dt><dd>
							Red Hat Quay runs on a machine with image storage, containerized database, Redis, and optionally, Clair security scanning.
						</dd><dt><span class="term">Highly available setups</span></dt><dd><p class="simpara">
							Red Hat Quay and Clair run in containers across multiple hosts. You can use <code class="literal">systemd</code> units to ensure restart on failure or reboot.
						</p><p class="simpara">
							High availability setups on standalone hosts require customer-provided load balancers, either low-level TCP load balancers or application load balancers, capable of terminating TLS.
						</p></dd></dl></div></section><section class="section" id="arch-quay-openshift"><div class="titlepage"><div><div><h2 class="title">3.2. Running Red Hat Quay on OpenShift</h2></div></div></div><p>
				The Red Hat Quay Operator for OpenShift Container Platform provides the following features:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Automated deployment and management of Red Hat Quay with customization options
					</li><li class="listitem">
						Management of Red Hat Quay and all of its dependencies
					</li><li class="listitem">
						Automated scaling and updates
					</li><li class="listitem">
						Integration with existing OpenShift Container Platform processes like GitOps, monitoring, alerting, logging
					</li><li class="listitem">
						Provision of object storage with limited availability, backed by the multi-cloud object gateway (NooBaa), as part of the Red Hat OpenShift Data Foundation (ODF) Operator. This service does not require an additional subscription.
					</li><li class="listitem">
						Scaled-out, high availability object storage provided by the ODF Operator. This service requires an additional subscription.
					</li></ul></div><p>
				Red Hat Quay can run on OpenShift Container Platform infrastructure nodes. As a result, no further subscriptions are required. Running Red Hat Quay on OpenShift Container Platform has the following benefits:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						<span class="strong strong"><strong>Zero to Hero:</strong></span> Simplified deployment of Red Hat Quay and associated components means that you can start using the product immediately
					</li><li class="listitem">
						<span class="strong strong"><strong>Scalability:</strong></span> Use cluster compute capacity to manage demand through automated scaling, based on actual load
					</li><li class="listitem">
						<span class="strong strong"><strong>Simplified Networking:</strong></span> Automated provisioning of load balancers and traffic ingress secured through HTTPS using OpenShift Container Platform TLS certificates and Routes
					</li><li class="listitem">
						<span class="strong strong"><strong>Declarative configuration management:</strong></span> Configurations stored in CustomResource objects for GitOps-friendly lifecycle management
					</li><li class="listitem">
						<span class="strong strong"><strong>Repeatability:</strong></span> Consistency regardless of the number of replicas of Red Hat Quay and Clair
					</li><li class="listitem">
						<span class="strong strong"><strong>OpenShift integration:</strong></span> Additional services to use OpenShift Container Platform Monitoring and Alerting facilities to manage multiple Red Hat Quay deployments on a single cluster
					</li></ul></div></section><section class="section" id="arch-integrating-standalone-ocp"><div class="titlepage"><div><div><h2 class="title">3.3. Integrating standalone Red Hat Quay with OpenShift Container Platform</h2></div></div></div><p>
				While the Red Hat Quay Operator ensures seamless deployment and management of Red Hat Quay running on OpenShift Container Platform, it is also possible to run Red Hat Quay in standalone mode and then serve content to one or many OpenShift Container Platform clusters, wherever they are running.
			</p><div class="formalpara"><p class="title"><strong>Integrating standalone Red Hat Quay with OpenShift Container Platform</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_deployment_ex2.png" alt="Integrating standalone Red Hat Quay with OpenShift Container Platform"/></span>
				</p></div><p>
				Several Operators are available to help integrate standalone and Operator based deployments ofRed Hat Quay with OpenShift Container Platform, like the following:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Red Hat Quay Cluster Security Operator</span></dt><dd>
							Relays Red Hat Quay vulnerability scanning results into the OpenShift Container Platform console
						</dd><dt><span class="term">Red Hat Quay Bridge Operator</span></dt><dd>
							Ensures seamless integration and user experience by using Red Hat Quay with OpenShift Container Platform in conjunction with OpenShift Container Platform Builds and ImageStreams
						</dd></dl></div></section><section class="section" id="arch-mirror-registry"><div class="titlepage"><div><div><h2 class="title">3.4. Mirror registry for Red Hat OpenShift</h2></div></div></div><p>
				The <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> is small-scale version of Red Hat Quay that you can use as a target for mirroring the required container images of OpenShift Container Platform for disconnected installations.
			</p><p>
				For disconnected deployments of OpenShift Container Platform, a container registry is required to carry out the installation of the clusters. To run a production-grade registry service on such a cluster, you must create a separate registry deployment to install the first cluster. The <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> addresses this need and is included in every OpenShift Container Platform subscription. It is available for download on the <a class="link" href="https://console.redhat.com/openshift/downloads#tool-mirror-registry">OpenShift console <span class="strong strong"><strong>Downloads</strong></span></a> page.
			</p><p>
				The <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> allows users to install a small-scale version of Red Hat Quay and its required components using the <code class="literal">mirror-registry</code> command line interface (CLI) tool. The <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> is deployed automatically with pre-configured local storage and a local database. It also includes auto-generated user credentials and access permissions with a single set of inputs and no additional configuration choices to get started.
			</p><p>
				The <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> provides a pre-determined network configuration and reports deployed component credentials and access URLs upon success. A limited set of optional configuration inputs like fully qualified domain name (FQDN) services, superuser name and password, and custom TLS certificates are also provided. This provides users with a container registry so that they can easily create an offline mirror of all OpenShift Container Platform release content when running OpenShift Container Platform in restricted network environments.
			</p><p>
				The <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> is limited to hosting images that are required to install a disconnected OpenShift Container Platform cluster, such as release images or Operator images. It uses local storage. Content built by customers should not be hosted by the <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span>.
			</p><p>
				Unlike Red Hat Quay, the <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> is not a highly-available registry. Only local file system storage is supported. Using the <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> with more than one cluster is discouraged, because multiple clusters can create a single point of failure when updating your cluster fleet. It is advised to use the <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span> to install a cluster that can host a production-grade, highly available registry such as Red Hat Quay, which can serve OpenShift Container Platform content to other clusters.
			</p><p>
				More information is available at <a class="link" href="https://docs.openshift.com/container-platform/4.10/installing/disconnected_install/installing-mirroring-creating-registry.html">Creating a mirror registry with <span class="emphasis"><em>mirror registry for Red Hat OpenShift</em></span></a>.
			</p></section><section class="section" id="core-distinct-registries"><div class="titlepage"><div><div><h2 class="title">3.5. Single compared to multiple registries</h2></div></div></div><p>
				Many users consider running multiple, distinct registries. The preferred approach with Red Hat Quay is to have a single, shared registry:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						If you want a clear separation between development and production images, or a clear separation by content origin, for example, keeping third-party images distinct from internal ones, you can use organizations and repositories, combined with role-based access control (RBAC), to achieve the desired separation.
					</li><li class="listitem">
						Given that the image registry is a critical component in an enterprise environment, you may be tempted to use distinct deployments to test upgrades of the registry software to newer versions. The Red Hat Quay Operator updates the registry for patch releases as well as minor or major updates. This means that any complicated procedures are automated and, as a result, there is no requirement for you to provision multiple instances of the registry to test the upgrade.
					</li><li class="listitem">
						With Red Hat Quay, there is no need to have a separate registry for each cluster you deploy. Red Hat Quay is proven to work at scale at <a class="link" href="https://quay.io">Quay.io</a>, and can serve content to thousands of clusters.
					</li><li class="listitem">
						Even if you have deployments in multiple data centers, you can still use a single Red Hat Quay instance to serve content to multiple physically-close data centers, or use the HA functionality with load balancers to stretch across data centers. Alternatively, you can use the Red Hat Quay geo-replication feature to stretch across physically distant data centers. This requires the provisioning of a global load balancer or DNS-based geo-aware load balancing.
					</li><li class="listitem">
						One scenario where it may be appropriate to run multiple distinct registries, is when you want to specify different configuration for each registry.
					</li></ul></div><p>
				In summary, running a shared registry helps you to save storage, infrastructure and operational costs, but a dedicated registry might be needed in specific circumstances.
			</p></section></section><section class="chapter" id="sample-quay-on-prem-intro"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Deploying Red Hat Quay on premise</h1></div></div></div><p>
			The following image shows examples for on premise configuration, for the following types of deployments:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Standalone Proof of Concept
				</li><li class="listitem">
					Highly available deployment on multiple hosts
				</li><li class="listitem">
					Deployment on an OpenShift Container Platform cluster by using the Red Hat Quay Operator
				</li></ul></div><div class="formalpara"><p class="title"><strong>On premise example configurations</strong></p><p>
				<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_on-premises_config.png" alt="On premise example configuration"/></span>
			</p></div><section class="section" id="core-example-deployment"><div class="titlepage"><div><div><h2 class="title">4.1. Red Hat Quay example deployments</h2></div></div></div><p>
				The following image shows three possible deployments for Red Hat Quay:
			</p><div class="formalpara"><p class="title"><strong>Deployment examples</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_deployment_ex1.png" alt="Red Hat Quay deployment example"/></span>
				</p></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Proof of Concept</span></dt><dd>
							Running Red Hat Quay, Clair, and mirroring on a single node, with local image storage and local database
						</dd><dt><span class="term">Single data center</span></dt><dd>
							Running highly available Red Hat Quay, Clair ,and mirroring, on multiple nodes, with HA database and image storage
						</dd><dt><span class="term">Multiple data centers</span></dt><dd>
							Running highly available Red Hat Quay, Clair, and mirroring, on multiple nodes in multiple data centers, with HA database and image storage
						</dd></dl></div></section><section class="section" id="deployment-topology"><div class="titlepage"><div><div><h2 class="title">4.2. Red Hat Quay deployment topology</h2></div></div></div><p>
				The following image provides a high level overview of a Red Hat Quay deployment topology:
			</p><div class="formalpara"><p class="title"><strong>Red Hat Quay deployment topology</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_deploy_topology.png" alt="Red Hat Quay deployment topology"/></span>
				</p></div><p>
				In this deployment, all pushes, user interface, and API requests are received by public Red Hat Quay endpoints. Pulls are served directly from <code class="literal">object storage</code>.
			</p></section><section class="section" id="deployment-topology-with-storage-proxy"><div class="titlepage"><div><div><h2 class="title">4.3. Red Hat Quay deployment topology with storage proxy</h2></div></div></div><p>
				The following image provides a high level overview of a Red Hat Quay deployment topology with storage proxy configured:
			</p><div class="formalpara"><p class="title"><strong>Red Hat Quay deployment topology with storage proxy</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_deploy_topology_storage.png" alt="Red Hat Quay deployment topology with storage proxy"/></span>
				</p></div><p>
				With storage proxy configured, all traffic passes through the public Red Hat Quay endpoint.
			</p></section></section><section class="chapter" id="arch-deploy-quay-public-cloud"><div class="titlepage"><div><div><h1 class="title">Chapter 5. Deploying Red Hat Quay on public cloud</h1></div></div></div><p>
			Red Hat Quay can run on public clouds, either in standalone mode or where OpenShift Container Platform itself has been deployed on public cloud. A full list of tested and supported configurations can be found in the Red Hat Quay <span class="strong strong"><strong>Tested Integrations Matrix</strong></span> at <a class="link" href="https://access.redhat.com/articles/4067991">https://access.redhat.com/articles/4067991</a>.
		</p><p>
			<span class="strong strong"><strong>Recommendation:</strong></span> If Red Hat Quay is running on public cloud, then you should use the public cloud services for Red Hat Quay backend services to ensure proper high availability and scalability.
		</p><section class="section" id="arch-quay-on-aws"><div class="titlepage"><div><div><h2 class="title">5.1. Running Red Hat Quay on Amazon Web Services</h2></div></div></div><p>
				If Red Hat Quay is running on Amazon Web Services (AWS), you can use the following features:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						AWS Elastic Load Balancer
					</li><li class="listitem">
						AWS S3 (hot) blob storage
					</li><li class="listitem">
						AWS RDS database
					</li><li class="listitem">
						AWS ElastiCache Redis
					</li><li class="listitem">
						EC2 virtual machine recommendation: M3.Large or M4.XLarge
					</li></ul></div><p>
				The following image provides a high level overview of Red Hat Quay running on AWS:
			</p><div class="formalpara"><p class="title"><strong>Red Hat Quay on AWS</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_on_AWS.png" alt="Red Hat Quay on AWS"/></span>
				</p></div></section><section class="section" id="arch-quay-on-azure"><div class="titlepage"><div><div><h2 class="title">5.2. Running Red Hat Quay on Microsoft Azure</h2></div></div></div><p>
				If Red Hat Quay is running on Microsoft Azure, you can use the following features:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Azure managed services such as highly available PostgreSQL
					</li><li class="listitem"><p class="simpara">
						Azure Blob Storage must be hot storage
					</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
								Azure cool storage is not available for Red Hat Quay
							</li></ul></div></li><li class="listitem">
						Azure Cache for Redis
					</li></ul></div><p>
				The following image provides a high level overview of Red Hat Quay running on Microsoft Azure:
			</p><div class="formalpara"><p class="title"><strong>Red Hat Quay on Microsoft Azure</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_on_Azure.png" alt="Red Hat Quay on Microsoft Azure"/></span>
				</p></div></section></section><section class="chapter" id="content-distrib-intro"><div class="titlepage"><div><div><h1 class="title">Chapter 6. Content distribution with Red Hat Quay</h1></div></div></div><p>
			Content distribution features in Red Hat Quay include:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<a class="link" href="#arch-mirroring-intro" title="6.1. Repository mirroring">Repository mirroring</a>
				</li><li class="listitem">
					<a class="link" href="#georepl-intro" title="6.2. Geo-replication">Geo-replication</a>
				</li><li class="listitem">
					<a class="link" href="#arch-airgap-intro" title="6.4. Air-gapped or disconnected deployments">Deployment in air-gapped environments</a>
				</li></ul></div><section class="section" id="arch-mirroring-intro"><div class="titlepage"><div><div><h2 class="title">6.1. Repository mirroring</h2></div></div></div><p>
				Red Hat Quay repository mirroring lets you mirror images from external container registries, or another local registry, into your Red Hat Quay cluster. Using repository mirroring, you can synchronize images to Red Hat Quay based on repository names and tags.
			</p><p>
				From your Red Hat Quay cluster with repository mirroring enabled, you can perform the following:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Choose a repository from an external registry to mirror
					</li><li class="listitem">
						Add credentials to access the external registry
					</li><li class="listitem">
						Identify specific container image repository names and tags to sync
					</li><li class="listitem">
						Set intervals at which a repository is synced
					</li><li class="listitem">
						Check the current state of synchronization
					</li></ul></div><p>
				To use the mirroring functionality, you need to perform the following actions:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Enable repository mirroring in the Red Hat Quay configuration file
					</li><li class="listitem">
						Run a repository mirroring worker
					</li><li class="listitem">
						Create mirrored repositories
					</li></ul></div><p>
				All repository mirroring configurations can be performed using the configuration tool UI or by the Red Hat Quay API.
			</p><section class="section" id="arch-mirroring-using"><div class="titlepage"><div><div><h3 class="title">6.1.1. Using repository mirroring</h3></div></div></div><p>
					The following list shows features and limitations of Red Hat Quay repository mirroring:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							With repository mirroring, you can mirror an entire repository or selectively limit which images are synced. Filters can be based on a comma-separated list of tags, a range of tags, or other means of identifying tags through Unix shell-style wildcards. For more information, see the documentation for <a class="link" href="https://tldp.org/LDP/GNU-Linux-Tools-Summary/html/x11655.htm">wildcards</a>.
						</li><li class="listitem">
							When a repository is set as mirrored, you cannot manually add other images to that repository.
						</li><li class="listitem">
							Because the mirrored repository is based on the repository and tags you set, it will hold only the content represented by the repository and tag pair. For example if you change the tag so that some images in the repository no longer match, those images will be deleted.
						</li><li class="listitem">
							Only the designated robot can push images to a mirrored repository, superseding any role-based access control permissions set on the repository.
						</li><li class="listitem">
							Mirroring can be configured to rollback on failure, <span class="emphasis"><em>or</em></span> to run on a best-effort basis.
						</li><li class="listitem">
							With a mirrored repository, a user with <span class="emphasis"><em>read</em></span> permissions can pull images from the repository but cannot push images to the repository.
						</li><li class="listitem">
							Changing settings on your mirrored repository can be performed in the Red Hat Quay user interface, using the <span class="strong strong"><strong>Repositories</strong></span> → <span class="strong strong"><strong>Mirrors</strong></span> tab for the mirrored repository you create.
						</li><li class="listitem">
							Images are synced at set intervals, but can also be synced on demand.
						</li></ul></div></section><section class="section" id="arch-mirroring-recommend"><div class="titlepage"><div><div><h3 class="title">6.1.2. Repository mirroring recommendations</h3></div></div></div><p>
					Best practices for repository mirroring include the following:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Repository mirroring pods can run on any node. This means that you can run mirroring on nodes where Red Hat Quay is already running.
						</li><li class="listitem">
							Repository mirroring is scheduled in the database and runs in batches. As a result, repository workers check each repository mirror configuration file and reads when the next sync needs to be. More mirror workers means more repositories can be mirrored at the same time. For example, running 10 mirror workers means that a user can run 10 mirroring operators in parallel. If a user only has 2 workers with 10 mirror configurations, only 2 operators can be performed.
						</li><li class="listitem"><p class="simpara">
							The optimal number of mirroring pods depends on the following conditions:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
									The total number of repositories to be mirrored
								</li><li class="listitem">
									The number of images and tags in the repositories and the frequency of changes
								</li><li class="listitem"><p class="simpara">
									Parallel batching
								</p><p class="simpara">
									For example, if a user is mirroring a repository that has 100 tags, the mirror will be completed by one worker. Users must consider how many repositories one wants to mirror in parallel, and base the number of workers around that.
								</p><p class="simpara">
									Multiple tags in the same repository cannot be mirrored in parallel.
								</p></li></ul></div></li></ul></div></section><section class="section" id="arch-mirroring-events"><div class="titlepage"><div><div><h3 class="title">6.1.3. Event notifications for mirroring</h3></div></div></div><p>
					There are three notification events for repository mirroring:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Repository Mirror Started
						</li><li class="listitem">
							Repository Mirror Success
						</li><li class="listitem">
							Repository Mirror Unsuccessful
						</li></ul></div><p>
					The events can be configured inside of the <span class="strong strong"><strong>Settings</strong></span> tab for each repository, and all existing notification methods such as email, Slack, Quay UI, and webhooks are supported.
				</p></section><section class="section" id="arch-mirroring-api-intro"><div class="titlepage"><div><div><h3 class="title">6.1.4. Mirroring API</h3></div></div></div><p>
					You can use the Red Hat Quay API to configure repository mirroring:
				</p><div class="formalpara"><p class="title"><strong>Mirroring API</strong></p><p>
						<span class="inlinemediaobject"><img src="images/swagger-mirroring.png" alt="Mirroring API"/></span>
					</p></div><p>
					More information is available in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3/html-single/red_hat_quay_api_guide/index">Red Hat Quay API Guide</a>
				</p></section></section><section class="section" id="georepl-intro"><div class="titlepage"><div><div><h2 class="title">6.2. Geo-replication</h2></div></div></div><p>
				Geo-replication allows multiple, geographically distributed Red Hat Quay deployments to work as a single registry from the perspective of a client or user. It significantly improves push and pull performance in a globally-distributed Red Hat Quay setup. Image data is asynchronously replicated in the background with transparent failover and redirect for clients.
			</p><p>
				Deployments of Red Hat Quay with geo-replication is supported on standalone and Operator deployments.
			</p><section class="section" id="arch-georpl-features"><div class="titlepage"><div><div><h3 class="title">6.2.1. Geo-replication features</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							When geo-replication is configured, container image pushes will be written to the preferred storage engine for that Red Hat Quay instance. This is typically the nearest storage backend within the region.
						</li><li class="listitem">
							After the initial push, image data will be replicated in the background to other storage engines.
						</li><li class="listitem">
							The list of replication locations is configurable and those can be different storage backends.
						</li><li class="listitem">
							An image pull will always use the closest available storage engine, to maximize pull performance.
						</li><li class="listitem">
							If replication has not been completed yet, the pull will use the source storage backend instead.
						</li></ul></div></section><section class="section" id="arch-georepl-prereqs"><div class="titlepage"><div><div><h3 class="title">6.2.2. Geo-replication requirements and constraints</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							In geo-replicated setups, Red Hat Quay requires that all regions are able to read and write to all other region’s object storage. Object storage must be geographically accessible by all other regions.
						</li><li class="listitem">
							In case of an object storage system failure of one geo-replicating site, that site’s Red Hat Quay deployment must be shut down so that clients are redirected to the remaining site with intact storage systems by a global load balancer. Otherwise, clients will experience pull and push failures.
						</li><li class="listitem">
							Red Hat Quay has no internal awareness of the health or availability of the connected object storage system. If the object storage system of one site becomes unavailable, there will be no automatic redirect to the remaining storage system, or systems, of the remaining site, or sites.
						</li><li class="listitem">
							Geo-replication is asynchronous. The permanent loss of a site incurs the loss of the data that has been saved in that sites' object storage system but has not yet been replicated to the remaining sites at the time of failure.
						</li><li class="listitem"><p class="simpara">
							A single database, and therefore all metadata and Red Hat Quay configuration, is shared across all regions.
						</p><p class="simpara">
							Geo-replication does not replicate the database. In the event of an outage, Red Hat Quay with geo-replication enabled will not failover to another database.
						</p></li><li class="listitem">
							A single Redis cache is shared across the entire Red Hat Quay setup and needs to accessible by all Red Hat Quay pods.
						</li><li class="listitem">
							The exact same configuration should be used across all regions, with exception of the storage backend, which can be configured explicitly using the <code class="literal">QUAY_DISTRIBUTED_STORAGE_PREFERENCE</code> environment variable.
						</li><li class="listitem">
							Geo-replication requires object storage in each region. It does not work with local storage.
						</li><li class="listitem">
							Each region must be able to access every storage engine in each region, which requires a network path.
						</li><li class="listitem">
							Alternatively, the storage proxy option can be used.
						</li><li class="listitem">
							The entire storage backend, for example, all blobs, is replicated. Repository mirroring, by contrast, can be limited to a repository, or an image.
						</li><li class="listitem">
							All Red Hat Quay instances must share the same entrypoint, typically through a load balancer.
						</li><li class="listitem">
							All Red Hat Quay instances must have the same set of superusers, as they are defined inside the common configuration file.
						</li><li class="listitem">
							Geo-replication requires your Clair configuration to be set to <code class="literal">unmanaged</code>. An unmanaged Clair database allows the Red Hat Quay Operator to work in a geo-replicated environment, where multiple instances of the Red Hat Quay Operator must communicate with the same database. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/deploy_red_hat_quay_on_openshift_with_the_quay_operator/index#clair-unmanaged">Advanced Clair configuration</a>.
						</li><li class="listitem">
							Geo-Replication requires SSL/TLS certificates and keys. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/index#using_ssl_to_protect_connections_to_red_hat_quay">Using SSL/TLS to protect connections to Red Hat Quay</a>.
						</li></ul></div><p>
					If the above requirements cannot be met, you should instead use two or more distinct Red Hat Quay deployments and take advantage of repository mirroring functions.
				</p></section><section class="section" id="georepl-arch-standalone"><div class="titlepage"><div><div><h3 class="title">6.2.3. Geo-replication using standalone Red Hat Quay</h3></div></div></div><p>
					In the following image, Red Hat Quay is running standalone in two separate regions, with a common database and a common Redis instance. Localized image storage is provided in each region and image pulls are served from the closest available storage engine. Container image pushes are written to the preferred storage engine for the Red Hat Quay instance, and will then be replicated, in the background, to the other storage engines.
				</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						If Clair fails in one cluster, for example, the US cluster, US users would not see vulnerability reports in Red Hat Quay for the second cluster (EU). This is because all Clair instances have the same state. When Clair fails, it is usually because of a problem within the cluster.
					</p></div></div><div class="formalpara"><p class="title"><strong>Geo-replication architecture</strong></p><p>
						<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_georeplication.png" alt="Geo-replication"/></span>
					</p></div></section><section class="section" id="georepl-arch-operator"><div class="titlepage"><div><div><h3 class="title">6.2.4. Geo-replication using the Red Hat Quay Operator</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_georeplication_openshift-temp.png" alt="Geo-replication architecture"/></span>
				</p><p>
					In the example shown above, the Red Hat Quay Operator is deployed in two separate regions, with a common database and a common Redis instance. Localized image storage is provided in each region and image pulls are served from the closest available storage engine. Container image pushes are written to the preferred storage engine for the Quay instance, and will then be replicated, in the background, to the other storage engines.
				</p><p>
					Because the Operator now manages the Clair security scanner and its database separately, geo-replication setups can be leveraged so that they do not manage the Clair database. Instead, an external shared database would be used. Red Hat Quay and Clair support several providers and vendors of PostgreSQL, which can be found in the Red Hat Quay 3.x <a class="link" href="https://access.redhat.com/articles/4067991">test matrix</a>. Additionally, the Operator also supports custom Clair configurations that can be injected into the deployment, which allows users to configure Clair with the connection credentials for the external database.
				</p></section><section class="section" id="georepl-mixed-storage"><div class="titlepage"><div><div><h3 class="title">6.2.5. Mixed storage for geo-replication</h3></div></div></div><p>
					Red Hat Quay geo-replication supports the use of different and multiple replication targets, for example, using AWS S3 storage on public cloud and using Ceph storage on premise. This complicates the key requirement of granting access to all storage backends from all Red Hat Quay pods and cluster nodes. As a result, it is recommended that you use the following:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							A VPN to prevent visibility of the internal storage, <span class="emphasis"><em>or</em></span>
						</li><li class="listitem">
							A token pair that only allows access to the specified bucket used by Red Hat Quay
						</li></ul></div><p>
					This results in the public cloud instance of Red Hat Quay having access to on-premise storage, but the network will be encrypted, protected, and will use ACLs, thereby meeting security requirements.
				</p><p>
					If you cannot implement these security measures, it might be preferable to deploy two distinct Red Hat Quay registries and to use repository mirroring as an alternative to geo-replication.
				</p></section></section><section class="section" id="mirroring-versus-georepl"><div class="titlepage"><div><div><h2 class="title">6.3. Repository mirroring compared to geo-replication</h2></div></div></div><p>
				Red Hat Quay geo-replication mirrors the entire image storage backend data between 2 or more different storage backends while the database is shared, for example, one Red Hat Quay registry with two different blob storage endpoints. The primary use cases for geo-replication include the following:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Speeding up access to the binary blobs for geographically dispersed setups
					</li><li class="listitem">
						Guaranteeing that the image content is the same across regions
					</li></ul></div><p>
				Repository mirroring synchronizes selected repositories, or subsets of repositories, from one registry to another. The registries are distinct, with each registry having a separate database and separate image storage.
			</p><p>
				The primary use cases for mirroring include the following:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Independent registry deployments in different data centers or regions, where a certain subset of the overall content is supposed to be shared across the data centers and regions
					</li><li class="listitem">
						Automatic synchronization or mirroring of selected (allowlisted) upstream repositories from external registries into a local Red Hat Quay deployment
					</li></ul></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					Repository mirroring and geo-replication can be used simultaneously.
				</p></div></div><div class="table" id="idm46054463361712"><p class="title"><strong>Table 6.1. Red Hat Quay Repository mirroring and geo-replication comparison</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 33%; " class="col_1"/><col style="width: 33%; " class="col_2"/><col style="width: 33%; " class="col_3"/></colgroup><thead><tr><th align="left" valign="top" id="idm46054463342736" scope="col">Feature / Capability</th><th align="left" valign="top" id="idm46054462811232" scope="col">Geo-replication</th><th align="left" valign="top" id="idm46054462810368" scope="col">Repository mirroring</th></tr></thead><tbody><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								What is the feature designed to do?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								A shared, global registry
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								Distinct, different registries
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								What happens if replication or mirroring has not been completed yet?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								The remote copy is used (slower)
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								No image is served
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								Is access to all storage backends in both regions required?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								Yes (all Red Hat Quay nodes)
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								No (distinct storage)
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								Can users push images from both sites to the same repository?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								Yes
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								No
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								Is all registry content and configuration identical across all regions (shared database)?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								Yes
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								No
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								Can users select individual namespaces or repositories to be mirrored?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								No
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								Yes
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								Can users apply filters to synchronization rules?
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								No
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								Yes
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463342736">
							<p>
								Are individual / different role-base access control configurations allowed in each region
							</p>
							</td><td align="left" valign="top" headers="idm46054462811232">
							<p>
								No
							</p>
							</td><td align="left" valign="top" headers="idm46054462810368">
							<p>
								Yes
							</p>
							</td></tr></tbody></table></div></div></section><section class="section" id="arch-airgap-intro"><div class="titlepage"><div><div><h2 class="title">6.4. Air-gapped or disconnected deployments</h2></div></div></div><p>
				In the following diagram, the upper deployment in the diagram shows Red Hat Quay and Clair connected to the internet, with an air-gapped OpenShift Container Platform cluster accessing the Red Hat Quay registry through an explicit, allowlisted hole in the firewall.
			</p><p>
				The lower deployment in the diagram shows Red Hat Quay and Clair running inside of the firewall, with image and CVE data transferred to the target system using offline media. The data is exported from a separate Red Hat Quay and Clair deployment that is connected to the internet.
			</p><p>
				The following diagram shows how Red Hat Quay and Clair can be deployed in air-gapped or disconnected environments:
			</p><div class="formalpara"><p class="title"><strong>Red Hat Quay and Clair in disconnected, or air-gapped, environments</strong></p><p>
					<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_air-gapped.png" alt="Air-gapped deployment"/></span>
				</p></div></section></section><section class="chapter" id="sizing-intro"><div class="titlepage"><div><div><h1 class="title">Chapter 7. Red Hat Quay sizing and subscriptions</h1></div></div></div><p>
			Scalability of Red Hat Quay is one of its key strengths, with a single code base supporting a broad spectrum of deployment sizes, including the following:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Proof of Concept deployment on a single development machine
				</li><li class="listitem">
					Mid-size deployment of approximately 2,000 users that can serve content to dozens of Kubernetes clusters
				</li><li class="listitem">
					High-end deployment such as <a class="link" href="https://quay.io">Quay.io</a> that can serve thousands of Kubernetes clusters world-wide
				</li></ul></div><p>
			Since sizing heavily depends on a multitude of factors, such as the number of users, images, concurrent pulls and pushes, there are no standard sizing recommendations.
		</p><p>
			The following are the minimum requirements for systems running Red Hat Quay (per container/pod instance):
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<span class="strong strong"><strong>Quay:</strong></span> minimum 6 GB; recommended 8 GB, 2 more more vCPUs
				</li><li class="listitem">
					<span class="strong strong"><strong>Clair:</strong></span> recommended 2 GB RAM and 2 or more vCPUs
				</li><li class="listitem">
					<span class="strong strong"><strong>Storage:</strong></span>: recommended 30 GB
				</li><li class="listitem">
					<span class="strong strong"><strong>NooBaa:</strong></span> minimum 2 GB, 1 vCPU (when <code class="literal">objectstorage</code> component is selected by the Operator)
				</li><li class="listitem">
					<span class="strong strong"><strong>Clair database:</strong></span> minimum 5 GB required for security metadata
				</li></ul></div><p>
			Stateless components of Red Hat Quay can be scaled out, but this will cause a heavier load on stateful backend services.
		</p><section class="section" id="sizing-sample"><div class="titlepage"><div><div><h2 class="title">7.1. Red Hat Quay sample sizings</h2></div></div></div><p>
				The following table shows approximate sizing for Proof of Concept, mid-size, and high-end deployments. Whether a deployment runs appropriately with the same metrics depends on many factors not shown below.
			</p><div class="informaltable"><table class="gt-4-cols lt-7-rows"><colgroup><col style="width: 40%; " class="col_1"/><col style="width: 20%; " class="col_2"/><col style="width: 20%; " class="col_3"/><col style="width: 20%; " class="col_4"/></colgroup><thead><tr><th align="left" valign="top" id="idm46054463237808" scope="col">Metric</th><th align="center" valign="top" id="idm46054464602624" scope="col">Proof of concept</th><th align="center" valign="top" id="idm46054464601760" scope="col">Mid-size</th><th align="center" valign="top" id="idm46054464600896" scope="col">High End<br/> (Quay.io)</th></tr></thead><tbody><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								No. of Quay containers by default
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								1
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								4
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								15
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								No. of Quay containers max at scale-out
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								N/A
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								8
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								30
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								No. of Clair containers by default
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								1
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								3
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								10
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								No. of Clair containers max at scale-out
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								N/A
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								6
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								15
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								No. of mirroring pods (to mirror 100 repositories)
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								1
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								5-10
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								N/A
							</p>
							</td></tr><tr><td align="left" valign="middle" headers="idm46054463237808">
							<p>
								Database sizing
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								2 -4 Cores<br/> 6-8 GB RAM<br/> 10-20 GB disk
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								4-8 Cores<br/> 6-32 GB RAM<br/> 100 GB - 1 TB disk
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								32 cores<br/> 244 GB<br/> 1+ TB disk
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								Object storage backend sizing
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								10-100 GB
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								1 - 20 TB
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								50+ TB up to PB
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								Redis cache sizing
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624"> </td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								2 Cores<br/> 2-4 GB RAM
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								4 cores <br/> 28 GB RAM
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm46054463237808">
							<p>
								Underlying node sizing<br/> (physical or virtual)
							</p>
							</td><td align="center" valign="top" headers="idm46054464602624">
							<p>
								4 Cores<br/> 8 GB RAM
							</p>
							</td><td align="center" valign="top" headers="idm46054464601760">
							<p>
								4-6 Cores<br/> 12-16 GB RAM
							</p>
							</td><td align="center" valign="top" headers="idm46054464600896">
							<p>
								Quay:<br/> 13 cores<br/> 56GB RAM<br/><br/> Clair:<br/> 2 cores<br/> 4 GB RAM
							</p>
							</td></tr></tbody></table></div><p>
				For further details on sizing &amp; related recommendations for mirroring, see the section on <a class="link" href="#arch-mirroring-intro" title="6.1. Repository mirroring">repository mirroring</a>.
			</p><p>
				The sizing for the Redis cache is only relevant if you use Quay builders, otherwise it is not significant.
			</p></section><section class="section" id="subscription-intro"><div class="titlepage"><div><div><h2 class="title">7.2. Red Hat Quay subscription information</h2></div></div></div><p>
				Red Hat Quay is available with Standard or Premium support, and subscriptions are based on deployments.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					Deployment means an installation of a single Red Hat Quay registry using a shared data backend.
				</p></div></div><p>
				With a Red Hat Quay subscription, the following options are available:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						There is no limit on the number of pods, such as Quay, Clair, Builder, and so on, that you can deploy.
					</li><li class="listitem">
						Red Hat Quay pods can run in multiple data centers or availability zones.
					</li><li class="listitem">
						Storage and database backends can be deployed across multiple data centers or availability zones, but only as a single, shared storage backend and single, shared database backend.
					</li><li class="listitem">
						Red Hat Quay can manage content for an unlimited number of clusters or standalone servers.
					</li><li class="listitem">
						Clients can access the Red Hat Quay deployment regardless of their physical location.
					</li><li class="listitem">
						You can deploy Red Hat Quay on OpenShift Container Platform infrastructure nodes to minimize subscription requirements.
					</li><li class="listitem">
						You can run the Container Security Operator (CSO) and the Quay Bridge Operator (QBO) on your OpenShift Container Platform clusters at no additional cost.
					</li></ul></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					Red Hat Quay geo-replication requires a subscription for each storage replication. The database, however, is shared.
				</p></div></div><p>
				For more information about purchasing a Red Hat Quay subscription, see <a class="link" href="https://www.redhat.com/en/technologies/cloud-computing/quay">Red Hat Quay</a>.
			</p></section><section class="section" id="quay-internal-registry-intro"><div class="titlepage"><div><div><h2 class="title">7.3. Using Red Hat Quay with or without internal registry</h2></div></div></div><p>
				Red Hat Quay can be used as an external registry in front of multiple OpenShift Container Platform clusters with their internal registries.
			</p><p>
				Red Hat Quay can also be used in place of the internal registry when it comes to automating builds and deployment rollouts. The required coordination of <code class="literal">Secrets</code> and <code class="literal">ImageStreams</code> is automated by the Quay Bridge Operator, which can be launched from the OperatorHub for OpenShift Container Platform.
			</p></section></section><div><div xml:lang="en-US" class="legalnotice" id="idm46054463269952"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2023 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>